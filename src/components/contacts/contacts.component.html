<div class="animate-fade-in">
  <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
    <h1 class="text-3xl font-bold text-slate-900 dark:text-white">{{ languageService.T('contacts') }}</h1>
     <div class="flex items-center gap-2">
      <input 
        type="text" 
        [placeholder]="languageService.T('searchBy')"
        class="w-64 bg-white dark:bg-slate-700 text-slate-900 dark:text-white rounded-md p-2 border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500 focus:outline-none"
        [value]="searchTerm()"
        (input)="searchTerm.set($any($event.target).value)">
      <button (click)="openModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center shrink-0 shadow-md hover:shadow-lg">
        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
        {{ languageService.T('newContact') }}
      </button>
      <button (click)="isImportModalOpen.set(true)" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg flex items-center shrink-0 shadow-md hover:shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
        {{ languageService.T('importFromCsv') }}
      </button>
      <button (click)="syncWithChatwood()" [disabled]="isSyncing()" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg flex items-center disabled:bg-slate-500 shrink-0 shadow-md hover:shadow-lg">
        @if(isSyncing()) {
          <svg class="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
          {{ languageService.T('syncing') }}
        } @else {
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.898 2.162l-1.5-1.5a1 1 0 111.414-1.414l4.243 4.242a1 1 0 010 1.414l-4.243 4.243a1 1 0 01-1.414-1.414l1.5-1.5a4.997 4.997 0 00-8.898-2.05L4 10V5a1 1 0 01-1-1H2a1 1 0 01-1-1V3a1 1 0 011-1h2z" clip-rule="evenodd" /></svg>
          {{ languageService.T('syncWithChatwood') }}
        }
      </button>
    </div>
  </div>

  <div class="bg-white dark:bg-slate-800 rounded-lg shadow-md border border-slate-200 dark:border-slate-700 overflow-hidden">
    @if(isLoading()) {
      <div class="p-8 text-center text-slate-500 dark:text-slate-400">{{ languageService.T('loading') }}</div>
    } @else {
      <div class="overflow-x-auto">
        <table class="w-full text-left">
          <thead class="bg-slate-50 dark:bg-slate-900/70 text-sm text-slate-500 dark:text-slate-400">
            <tr>
              <th class="p-4 font-semibold cursor-pointer hover:text-slate-800 dark:hover:text-white" (click)="updateSort('name')">{{ languageService.T('contactName') }}</th>
              <th class="p-4 font-semibold cursor-pointer hover:text-slate-800 dark:hover:text-white" (click)="updateSort('phone_number')">{{ languageService.T('phoneNumber') }}</th>
              <th class="p-4 font-semibold cursor-pointer hover:text-slate-800 dark:hover:text-white" (click)="updateSort('email')">{{ languageService.T('email') }}</th>
              <th class="p-4 font-semibold cursor-pointer hover:text-slate-800 dark:hover:text-white" (click)="updateSort('created_at')">{{ languageService.T('createdAt') }}</th>
              <th class="p-4 font-semibold text-right">{{ languageService.T('actions') }}</th>
            </tr>
          </thead>
          <tbody>
            @for(contact of filteredAndSortedContacts(); track contact.contact_id) {
              <tr class="border-t border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50">
                <td class="p-4 font-medium text-slate-800 dark:text-white">{{ contact.name }}</td>
                <td class="p-4 text-slate-600 dark:text-slate-300">{{ contact.phone_number }}</td>
                <td class="p-4 text-slate-600 dark:text-slate-300">{{ contact.email }}</td>
                <td class="p-4 text-slate-500 dark:text-slate-400">{{ formatDate(contact.created_at) }}</td>
                <td class="p-4 text-right">
                   <button (click)="openModal(contact)" class="text-blue-500 hover:text-blue-400 mr-4 text-sm">{{ languageService.T('edit') }}</button>
                   <button (click)="requestDelete(contact)" class="text-red-500 hover:text-red-400 text-sm">{{ languageService.T('delete') }}</button>
                </td>
              </tr>
            } @empty {
              <tr><td colspan="5" class="text-center p-8 text-slate-500 dark:text-slate-400">{{ searchTerm() ? languageService.T('noContactsFound') : languageService.T('noContactsConfigured') }}</td></tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>
</div>

<!-- Edit/Create Modal -->
@if (isModalOpen() && editingContact(); as contact) {
  <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-pop-in">
    <div class="bg-white dark:bg-slate-800 rounded-lg shadow-2xl p-8 w-full max-w-lg border border-slate-200 dark:border-slate-700">
      <h2 class="text-2xl font-bold mb-6 text-slate-900 dark:text-white">{{ languageService.T(contact.contact_id ? 'editContact' : 'createContact') }}</h2>
      <form #form="ngForm" (ngSubmit)="saveContact()">
        <div class="space-y-4 text-slate-600 dark:text-slate-300">
          <div>
            <label class="block mb-2 font-semibold">{{ languageService.T('contactName') }}</label>
            <input type="text" [(ngModel)]="contact.name" name="name" class="w-full bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white p-2 rounded-md border" [class.border-red-500]="contactValidationErrors().name" [class.border-slate-300]="!contactValidationErrors().name" [class.dark:border-slate-600]="!contactValidationErrors().name">
            @if(contactValidationErrors().name) {
              <p class="text-red-500 dark:text-red-400 text-sm mt-1">{{ contactValidationErrors().name }}</p>
            }
          </div>
          <div>
            <label class="block mb-2 font-semibold">{{ languageService.T('phoneNumber') }}</label>
            <input type="tel" [(ngModel)]="contact.phone_number" name="phone_number" class="w-full bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white p-2 rounded-md border" [placeholder]="languageService.T('contactPhonePlaceholder')" [class.border-red-500]="contactValidationErrors().phone_number" [class.border-slate-300]="!contactValidationErrors().phone_number" [class.dark:border-slate-600]="!contactValidationErrors().phone_number">
            @if(contactValidationErrors().phone_number) {
              <p class="text-red-500 dark:text-red-400 text-sm mt-1">{{ contactValidationErrors().phone_number }}</p>
            }
          </div>
          <div>
            <label class="block mb-2 font-semibold">{{ languageService.T('email') }}</label>
            <input type="email" [(ngModel)]="contact.email" name="email" class="w-full bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white p-2 rounded-md border" [class.border-red-500]="contactValidationErrors().email" [class.border-slate-300]="!contactValidationErrors().email" [class.dark:border-slate-600]="!contactValidationErrors().email">
            @if(contactValidationErrors().email) {
              <p class="text-red-500 dark:text-red-400 text-sm mt-1">{{ contactValidationErrors().email }}</p>
            }
          </div>
        </div>
        <div class="flex justify-end gap-4 mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
          <button type="button" (click)="closeModal()" class="bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-700 text-slate-800 dark:text-white font-bold py-2 px-4 rounded-lg">{{ languageService.T('cancel') }}</button>
          <button type="submit" [disabled]="form.invalid" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg disabled:bg-slate-400 dark:disabled:bg-slate-500">{{ languageService.T('saveContact') }}</button>
        </div>
      </form>
    </div>
  </div>
}

<!-- Delete Confirmation Modal -->
@if (contactToDelete(); as contact) {
  <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-pop-in">
    <div class="bg-white dark:bg-slate-800 rounded-lg shadow-2xl p-8 w-full max-w-md border border-slate-200 dark:border-slate-700 text-center">
      <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/50">
        <svg class="h-6 w-6 text-red-600 dark:text-red-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
        </svg>
      </div>
      <h2 class="text-2xl font-bold mt-4 text-slate-900 dark:text-white">{{ languageService.T('deleteConfirmationTitle') }}</h2>
      <p class="text-slate-500 dark:text-slate-400 mt-2">{{ languageService.T('deleteConfirmationMessage').replace('{itemType}', languageService.T('itemType_contact')).replace('{itemName}', contact.name || contact.contact_id) }}</p>
      <p class="text-sm text-red-500 dark:text-red-400 font-semibold mt-2">{{ languageService.T('deleteConfirmationWarning') }}</p>
      <div class="flex justify-center gap-4 mt-6">
        <button type="button" (click)="cancelDelete()" class="bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-700 text-slate-800 dark:text-white font-bold py-2 px-6 rounded-lg">{{ languageService.T('cancel') }}</button>
        <button type="button" (click)="confirmDelete()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">{{ languageService.T('confirmDeleteButton') }}</button>
      </div>
    </div>
  </div>
}

<!-- Import CSV Modal -->
@if (isImportModalOpen()) {
  <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-pop-in">
    <div class="bg-white dark:bg-slate-800 rounded-lg shadow-2xl p-8 w-full max-w-lg border border-slate-200 dark:border-slate-700">
      <h2 class="text-2xl font-bold mb-6 text-slate-900 dark:text-white">{{ languageService.T('importContacts') }}</h2>
      <div class="mb-4">
        <label for="csvFile" class="block text-slate-600 dark:text-slate-300 font-semibold mb-2">{{ languageService.T('selectCsvFile') }}</label>
        <input type="file" id="csvFile" (change)="onFileSelected($event)" accept=".csv" class="w-full text-sm text-slate-500 dark:text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700">
      </div>
      <p class="text-xs text-slate-500 dark:text-slate-400 mb-6">{{ languageService.T('csvFileFormat') }}</p>
      <div class="flex justify-end gap-4 mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
        <button type="button" (click)="isImportModalOpen.set(false)" class="bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-700 text-slate-800 dark:text-white font-bold py-2 px-4 rounded-lg">{{ languageService.T('cancel') }}</button>
        <button type="button" (click)="importCsv()" [disabled]="!selectedFile() || isImporting()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg disabled:bg-slate-400 dark:disabled:bg-slate-500 w-28 text-center">
           @if(isImporting()) {
            <span>{{ languageService.T('importing') }}...</span>
          } @else {
            <span>{{ languageService.T('import') }}</span>
          }
        </button>
      </div>
    </div>
  </div>
}

<!-- Import Result Modal -->
@if (isImportResultModalOpen() && importResult(); as result) {
  <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-pop-in">
    <div class="bg-white dark:bg-slate-800 rounded-lg shadow-2xl p-8 w-full max-w-2xl border border-slate-200 dark:border-slate-700 max-h-[90vh] flex flex-col">
      <h2 class="text-2xl font-bold mb-4 shrink-0 text-slate-900 dark:text-white">{{ languageService.T('importResultTitle') }}</h2>
      
      <div class="grid grid-cols-3 gap-4 mb-4 text-center shrink-0">
        <div class="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg"><div class="text-2xl font-bold text-slate-800 dark:text-white">{{ result.total_rows }}</div><div class="text-sm text-slate-500 dark:text-slate-400">{{ languageService.T('importTotalRows') }}</div></div>
        <div class="p-4 bg-green-100 dark:bg-green-900/50 rounded-lg"><div class="text-2xl font-bold text-green-600 dark:text-green-400">{{ result.successful_imports }}</div><div class="text-sm text-slate-500 dark:text-slate-400">{{ languageService.T('importSuccessful') }}</div></div>
        <div class="p-4 bg-red-100 dark:bg-red-900/50 rounded-lg"><div class="text-2xl font-bold text-red-600 dark:text-red-400">{{ result.failed_imports }}</div><div class="text-sm text-slate-500 dark:text-slate-400">{{ languageService.T('importFailed') }}</div></div>
      </div>

      @if (result.errors && result.errors.length > 0) {
        <div class="flex-grow overflow-y-auto mt-4 border-t border-slate-200 dark:border-slate-700 pt-4">
          <h3 class="font-semibold mb-2 text-slate-800 dark:text-white">{{ languageService.T('importErrorsList') }}:</h3>
          <ul class="space-y-2 text-sm text-red-700 dark:text-red-300 bg-slate-100 dark:bg-slate-900 p-3 rounded-md">
            @for(error of result.errors; track $index) {
              <li><span class="font-mono bg-red-200 dark:bg-red-900/70 py-0.5 px-1.5 rounded text-xs mr-2">{{ $index + 1 }}</span> {{ error }}</li>
            }
          </ul>
        </div>
      }

      <div class="flex justify-end gap-4 mt-6 shrink-0 pt-4 border-t border-slate-200 dark:border-slate-700">
        <button type="button" (click)="closeImportResultModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">{{ languageService.T('close') }}</button>
      </div>
    </div>
  </div>
}
