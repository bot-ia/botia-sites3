<div class="animate-fade-in">
  <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
    <h1 class="text-3xl font-bold text-slate-900 dark:text-white">{{ languageService.T('serviceOrders') }}</h1>
     <div class="flex items-center gap-4">
      <input 
        type="text" 
        [placeholder]="languageService.T('searchBy')"
        class="w-64 bg-white dark:bg-slate-700 text-slate-900 dark:text-white rounded-md p-2 border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500 focus:outline-none"
        [value]="searchTerm()"
        (input)="searchTerm.set($any($event.target).value)">
      <button (click)="openModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center shadow-md hover:shadow-lg">
        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
        {{ languageService.T('newServiceOrder') }}
      </button>
    </div>
  </div>

  <div class="bg-white dark:bg-slate-800 rounded-lg shadow-md border border-slate-200 dark:border-slate-700 overflow-hidden">
    @if(isLoading()) {
      <div class="p-8 text-center text-slate-500 dark:text-slate-400">{{ languageService.T('loading') }}</div>
    } @else {
      <div class="overflow-x-auto">
        <table class="w-full text-left">
          <thead class="bg-slate-50 dark:bg-slate-900/70 text-sm text-slate-500 dark:text-slate-400">
            <tr>
              <th class="p-4 font-semibold cursor-pointer hover:text-slate-800 dark:hover:text-white" (click)="updateSort('orderId')">{{ languageService.T('orderId') }}</th>
              <th class="p-4 font-semibold cursor-pointer hover:text-slate-800 dark:hover:text-white" (click)="updateSort('clientName')">{{ languageService.T('client') }}</th>
              <th class="p-4 font-semibold cursor-pointer hover:text-slate-800 dark:hover:text-white" (click)="updateSort('device')">{{ languageService.T('device') }}</th>
              <th class="p-4 font-semibold">{{ languageService.T('issue') }}</th>
              <th class="p-4 font-semibold cursor-pointer hover:text-slate-800 dark:hover:text-white" (click)="updateSort('createdAt')">{{ languageService.T('createdAt') }}</th>
              <th class="p-4 font-semibold cursor-pointer hover:text-slate-800 dark:hover:text-white" (click)="updateSort('status')">{{ languageService.T('status') }}</th>
              <th class="p-4 font-semibold text-right">{{ languageService.T('actions') }}</th>
            </tr>
          </thead>
          <tbody>
            @for(order of filteredAndSortedOrders(); track order.id) {
              <tr class="border-t border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50">
                <td class="p-4 font-mono text-indigo-500 dark:text-indigo-400">{{ order.orderId }}</td>
                <td class="p-4">
                  <div class="font-medium text-slate-800 dark:text-white">{{ order.clientName }}</div>
                  <div class="text-sm text-slate-500 dark:text-slate-400">{{ order.clientContact }}</div>
                </td>
                <td class="p-4 text-slate-600 dark:text-slate-300">{{ order.device }}</td>
                <td class="p-4 max-w-xs truncate text-slate-600 dark:text-slate-300">{{ order.issue }}</td>
                <td class="p-4 text-slate-500 dark:text-slate-400">{{ formatDate(order.createdAt) }}</td>
                <td class="p-4">
                  <select [value]="order.status" (change)="onStatusChange(order, $event)" class="bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white text-sm rounded-md p-2 border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    @for(status of statuses; track status) {
                      <option [value]="status">{{ languageService.T('serviceOrderStatus_' + status) }}</option>
                    }
                  </select>
                </td>
                <td class="p-4 text-right">
                   <button (click)="openModal(order)" class="text-blue-500 hover:text-blue-400 mr-4 text-sm">{{ languageService.T('edit') }}</button>
                   <button (click)="deleteOrder(order)" class="text-red-500 hover:text-red-400 text-sm">{{ languageService.T('delete') }}</button>
                </td>
              </tr>
            } @empty {
              <tr><td colspan="7" class="text-center p-8 text-slate-500 dark:text-slate-400">{{ languageService.T('noServiceOrdersFound') }}</td></tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>
</div>

<!-- Modal -->
@if (isModalOpen() && editingOrder(); as order) {
  <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-pop-in">
    <div class="bg-white dark:bg-slate-800 rounded-lg shadow-2xl p-8 w-full max-w-2xl border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300">
      <h2 class="text-2xl font-bold mb-6 text-slate-900 dark:text-white">{{ languageService.T(order.id ? 'editServiceOrder' : 'createServiceOrder') }}</h2>
      <form #form="ngForm" (ngSubmit)="saveOrder()">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block mb-2 font-semibold">{{ languageService.T('orderId') }}</label><input type="text" [(ngModel)]="order.orderId" name="orderId" class="w-full bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white p-2 rounded-md border border-slate-300 dark:border-slate-600 font-mono" required></div>
          <div><label class="block mb-2 font-semibold">{{ languageService.T('status') }}</label><select [(ngModel)]="order.status" name="status" class="w-full bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white p-2 rounded-md border border-slate-300 dark:border-slate-600" required>@for(s of statuses; track s){<option [value]="s">{{ languageService.T('serviceOrderStatus_' + s) }}</option>}</select></div>
          <div><label class="block mb-2 font-semibold">{{ languageService.T('clientName') }}</label><input type="text" [(ngModel)]="order.clientName" name="clientName" class="w-full bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white p-2 rounded-md border border-slate-300 dark:border-slate-600" required></div>
          <div><label class="block mb-2 font-semibold">{{ languageService.T('clientContact') }}</label><input type="text" [(ngModel)]="order.clientContact" name="clientContact" class="w-full bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white p-2 rounded-md border border-slate-300 dark:border-slate-600" required></div>
          <div class="md:col-span-2"><label class="block mb-2 font-semibold">{{ languageService.T('device') }}</label><input type="text" [(ngModel)]="order.device" name="device" class="w-full bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white p-2 rounded-md border border-slate-300 dark:border-slate-600" required></div>
          <div class="md:col-span-2"><label class="block mb-2 font-semibold">{{ languageService.T('issue') }}</label><textarea [(ngModel)]="order.issue" name="issue" class="w-full bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white p-2 rounded-md border border-slate-300 dark:border-slate-600 h-24" required></textarea></div>
        </div>
        <div class="flex justify-end gap-4 mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
          <button type="button" (click)="closeModal()" class="bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-700 text-slate-800 dark:text-white font-bold py-2 px-4 rounded-lg">{{ languageService.T('cancel') }}</button>
          <button type="submit" [disabled]="form.invalid" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg disabled:bg-slate-400 dark:disabled:bg-slate-500">{{ languageService.T('saveServiceOrder') }}</button>
        </div>
      </form>
    </div>
  </div>
}
