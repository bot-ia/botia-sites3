
<div class="animate-fade-in space-y-6">
  <!-- Header -->
  <div class="flex flex-wrap justify-between items-center gap-4">
    <h1 class="text-3xl font-bold text-slate-900 dark:text-white">{{ languageService.T('managePatientAppointments') }}</h1>
    <button (click)="openModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center shadow-md hover:shadow-lg transition-shadow">
      <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
      {{ languageService.T('newPatientAppointment') }}
    </button>
  </div>

  <!-- Filters -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 p-4 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 shadow-sm">
    <!-- Date Range -->
    <div class="flex flex-col">
      <label class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{ languageService.T('filterByDateRange') }}</label>
      <div class="flex items-center gap-2">
        <input type="date" [ngModel]="filters().startDate" (ngModelChange)="onFilterChange('startDate', $event)" class="w-full bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white text-sm rounded-md p-2 border border-slate-300 dark:border-slate-600 focus:ring-1 focus:ring-indigo-500 focus:outline-none">
        <input type="date" [ngModel]="filters().endDate" (ngModelChange)="onFilterChange('endDate', $event)" class="w-full bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white text-sm rounded-md p-2 border border-slate-300 dark:border-slate-600 focus:ring-1 focus:ring-indigo-500 focus:outline-none">
      </div>
    </div>
    <!-- Calendar -->
    <div>
      <label class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{ languageService.T('filterByCalendar') }}</label>
      <select [ngModel]="filters().calendarId" (ngModelChange)="onFilterChange('calendarId', $event)" class="w-full bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white text-sm rounded-md p-2 border border-slate-300 dark:border-slate-600 focus:ring-1 focus:ring-indigo-500 focus:outline-none">
        <option value="all">{{ languageService.T('all') }}</option>
        @for(cal of calendars(); track cal.calendar_id) { <option [value]="cal.calendar_id">{{ cal.name }}</option> }
      </select>
    </div>
    <!-- Procedure -->
    <div>
      <label class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{ languageService.T('filterByProcedure') }}</label>
      <select [ngModel]="filters().procedureId" (ngModelChange)="onFilterChange('procedureId', $event)" class="w-full bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white text-sm rounded-md p-2 border border-slate-300 dark:border-slate-600 focus:ring-1 focus:ring-indigo-500 focus:outline-none">
        <option value="all">{{ languageService.T('all') }}</option>
        @for(proc of procedures(); track proc.id) { <option [value]="proc.id">{{ proc.name }}</option> }
      </select>
    </div>
    <!-- Payment Status -->
    <div>
      <label class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{ languageService.T('filterByPaymentStatus') }}</label>
      <select [ngModel]="filters().paymentStatus" (ngModelChange)="onFilterChange('paymentStatus', $event)" class="w-full bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white text-sm rounded-md p-2 border border-slate-300 dark:border-slate-600 focus:ring-1 focus:ring-indigo-500 focus:outline-none">
        <option value="all">{{ languageService.T('all') }}</option>
        @for(status of paymentStatuses; track status) { <option [value]="status">{{ languageService.T('paymentStatus_' + status) }}</option> }
      </select>
    </div>
    <!-- Confirmation Status -->
    <div>
      <label class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{ languageService.T('filterByConfirmationStatus') }}</label>
      <select [ngModel]="filters().confirmationStatus" (ngModelChange)="onFilterChange('confirmationStatus', $event)" class="w-full bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white text-sm rounded-md p-2 border border-slate-300 dark:border-slate-600 focus:ring-1 focus:ring-indigo-500 focus:outline-none">
        <option value="all">{{ languageService.T('all') }}</option>
        @for(status of confirmationStatuses; track status) { <option [value]="status">{{ languageService.T('confirmationStatus_' + status) }}</option> }
      </select>
    </div>
  </div>

  <!-- Appointments Table -->
  <div class="bg-white dark:bg-slate-800 rounded-lg shadow-md border border-slate-200 dark:border-slate-700 overflow-hidden">
    @if(isLoading()) {
      <div class="p-8 text-center text-slate-500 dark:text-slate-400">{{ languageService.T('loading') }}</div>
    } @else {
      <div class="overflow-x-auto">
        <table class="w-full text-left min-w-[1200px]">
          <thead class="bg-slate-50 dark:bg-slate-900/70 text-sm text-slate-500 dark:text-slate-400">
            <tr>
              <th class="p-3 font-semibold">{{ languageService.T('patient') }}</th>
              <th class="p-3 font-semibold">{{ languageService.T('appointmentDate') }}</th>
              <th class="p-3 font-semibold">{{ languageService.T('calendars') }} / {{ languageService.T('professionals') }}</th>
              <th class="p-3 font-semibold">{{ languageService.T('procedures') }}</th>
              <th class="p-3 font-semibold">{{ languageService.T('paymentStatus') }}</th>
              <th class="p-3 font-semibold">{{ languageService.T('confirmationStatus') }}</th>
              <th class="p-3 font-semibold text-right">{{ languageService.T('actions') }}</th>
            </tr>
          </thead>
          <tbody>
            @for(appt of filteredAppointments(); track appt.appointment_id) {
              <tr class="border-t border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50">
                <td class="p-3 font-medium text-slate-700 dark:text-slate-200">{{ getContactName(appt.user_id) }}</td>
                <td class="p-3 text-slate-600 dark:text-slate-300">{{ formatDateTime(appt.appointment_date) }}</td>
                <td class="p-3">
                  @if (getCalendarInfo(appt.calendar_id); as calInfo) {
                    <div class="font-medium text-slate-700 dark:text-slate-200">{{ calInfo.name }}</div>
                    <div class="text-sm text-slate-500 dark:text-slate-400">{{ calInfo.professionalName }}</div>
                  }
                </td>
                <td class="p-3 text-slate-600 dark:text-slate-300">{{ getProcedureName(appt.procedure_id) }}</td>
                <td class="p-3">
                  <select (change)="updateStatus(appt, 'payment', $event)" class="text-sm rounded-md p-2 border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                    [class.bg-yellow-100]="appt.payment_status === 'pendiente'" [class.text-yellow-800]="appt.payment_status === 'pendiente'" [class.dark:bg-yellow-900/50]="appt.payment_status === 'pendiente'" [class.dark:text-yellow-300]="appt.payment_status === 'pendiente'"
                    [class.bg-green-100]="appt.payment_status === 'pagado'" [class.text-green-800]="appt.payment_status === 'pagado'" [class.dark:bg-green-900/50]="appt.payment_status === 'pagado'" [class.dark:text-green-300]="appt.payment_status === 'pagado'">
                    @for(status of paymentStatuses; track status) { <option [value]="status" [selected]="status === appt.payment_status">{{ languageService.T('paymentStatus_' + status) }}</option> }
                  </select>
                </td>
                <td class="p-3">
                   <select (change)="updateStatus(appt, 'confirmation', $event)" class="text-sm rounded-md p-2 border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                    [class.bg-blue-100]="appt.confirmation_status === 'agendada'" [class.text-blue-800]="appt.confirmation_status === 'agendada'" [class.dark:bg-blue-900/50]="appt.confirmation_status === 'agendada'" [class.dark:text-blue-300]="appt.confirmation_status === 'agendada'"
                    [class.bg-teal-100]="appt.confirmation_status === 'confirmada'" [class.text-teal-800]="appt.confirmation_status === 'confirmada'" [class.dark:bg-teal-900/50]="appt.confirmation_status === 'confirmada'" [class.dark:text-teal-300]="appt.confirmation_status === 'confirmada'"
                    [class.bg-green-100]="appt.confirmation_status === 'realizada'" [class.text-green-800]="appt.confirmation_status === 'realizada'" [class.dark:bg-green-900/50]="appt.confirmation_status === 'realizada'" [class.dark:text-green-300]="appt.confirmation_status === 'realizada'"
                    [class.bg-red-100]="appt.confirmation_status === 'cancelada'" [class.text-red-800]="appt.confirmation_status === 'cancelada'" [class.dark:bg-red-900/50]="appt.confirmation_status === 'cancelada'" [class.dark:text-red-300]="appt.confirmation_status === 'cancelada'">
                    @for(status of confirmationStatuses; track status) { <option [value]="status" [selected]="status === appt.confirmation_status">{{ languageService.T('confirmationStatus_' + status) }}</option> }
                  </select>
                </td>
                <td class="p-3 text-right">
                   <button (click)="openModal(appt)" class="text-blue-500 hover:text-blue-400 mr-4 text-sm">{{ languageService.T('edit') }}</button>
                   <button (click)="requestDeleteItem(appt)" class="text-red-500 hover:text-red-400 text-sm">{{ languageService.T('delete') }}</button>
                </td>
              </tr>
            } @empty {
              <tr><td colspan="7" class="p-8 text-center text-slate-500 dark:text-slate-400">{{ languageService.T('noPatientAppointmentsFound') }}</td></tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>
</div>

<!-- Modal -->
@if (isModalOpen() && editingAppointment(); as appt) {
  <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-pop-in">
    <div class="bg-white dark:bg-slate-800 rounded-lg shadow-2xl p-8 w-full max-w-2xl border border-slate-200 dark:border-slate-700">
      <h2 class="text-2xl font-bold mb-6 text-slate-900 dark:text-white">{{ languageService.T(appt.appointment_id ? 'editPatientAppointment' : 'createPatientAppointment') }}</h2>
      <form #form="ngForm" (ngSubmit)="saveItem()">
        <div class="space-y-4">
          <div><label class="block mb-2 font-semibold text-slate-600 dark:text-slate-300">{{ languageService.T('patient') }}</label><select [(ngModel)]="appt.user_id" name="user_id" class="w-full bg-slate-100 dark:bg-slate-700 p-2 rounded-md border border-slate-300 dark:border-slate-600" required><option value="" disabled>{{ languageService.T('selectPatient') }}</option>@for(c of contacts(); track c.contact_id){<option [value]="c.contact_id">{{c.name}} ({{c.phone_number}})</option>}</select></div>
          <div><label class="block mb-2 font-semibold text-slate-600 dark:text-slate-300">{{ languageService.T('appointmentDate') }}</label><input type="datetime-local" [(ngModel)]="appt.appointment_date" name="appointment_date" class="w-full bg-slate-100 dark:bg-slate-700 p-2 rounded-md border border-slate-300 dark:border-slate-600"></div>
          <div><label class="block mb-2 font-semibold text-slate-600 dark:text-slate-300">{{ languageService.T('calendars') }}</label><select [(ngModel)]="appt.calendar_id" name="calendar_id" class="w-full bg-slate-100 dark:bg-slate-700 p-2 rounded-md border border-slate-300 dark:border-slate-600"><option [ngValue]="null" disabled>{{ languageService.T('selectCalendar') }}</option>@for(c of calendars(); track c.calendar_id){<option [ngValue]="c.calendar_id">{{c.name}}</option>}</select></div>
          
          @if (isProcedureCalendar(appt.calendar_id)) {
            <div class="animate-fade-in-fast">
              <label class="block mb-2 font-semibold text-slate-600 dark:text-slate-300">{{ languageService.T('procedures') }}</label>
              <select [(ngModel)]="appt.procedure_id" name="procedure_id" class="w-full bg-slate-100 dark:bg-slate-700 p-2 rounded-md border border-slate-300 dark:border-slate-600" required>
                <option [ngValue]="null" disabled>{{ languageService.T('selectProcedure') }}</option>
                @for(p of procedures(); track p.id){<option [ngValue]="p.id">{{p.name}}</option>}
              </select>
            </div>
          }

          <div class="grid grid-cols-2 gap-4">
            <div><label class="block mb-2 font-semibold text-slate-600 dark:text-slate-300">{{ languageService.T('paymentStatus') }}</label><select [(ngModel)]="appt.payment_status" name="payment_status" class="w-full bg-slate-100 dark:bg-slate-700 p-2 rounded-md border border-slate-300 dark:border-slate-600" required>@for(s of paymentStatuses; track s){<option [value]="s">{{ languageService.T('paymentStatus_' + s) }}</option>}</select></div>
            <div><label class="block mb-2 font-semibold text-slate-600 dark:text-slate-300">{{ languageService.T('confirmationStatus') }}</label><select [(ngModel)]="appt.confirmation_status" name="confirmation_status" class="w-full bg-slate-100 dark:bg-slate-700 p-2 rounded-md border border-slate-300 dark:border-slate-600" required>@for(s of confirmationStatuses; track s){<option [value]="s">{{ languageService.T('confirmationStatus_' + s) }}</option>}</select></div>
          </div>
          <div><label class="block mb-2 font-semibold text-slate-600 dark:text-slate-300">{{ languageService.T('appointmentGoogleEventId') }}</label><input type="text" [(ngModel)]="appt.google_event_id" name="google_event_id" class="w-full bg-slate-100 dark:bg-slate-700 p-2 rounded-md border border-slate-300 dark:border-slate-600 font-mono"></div>
          <div><label class="block mb-2 font-semibold text-slate-600 dark:text-slate-300">{{ languageService.T('notes') }}</label><textarea [(ngModel)]="appt.notes" name="notes" class="w-full bg-slate-100 dark:bg-slate-700 p-2 rounded-md border border-slate-300 dark:border-slate-600 h-24"></textarea></div>
        </div>
        <div class="flex justify-end gap-4 mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
          <button type="button" (click)="closeModal()" class="bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-700 text-slate-800 dark:text-white font-bold py-2 px-4 rounded-lg">{{ languageService.T('cancel') }}</button>
          <button type="submit" [disabled]="form.invalid" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg disabled:bg-slate-400 dark:disabled:bg-slate-500">{{ languageService.T('save') }}</button>
        </div>
      </form>
    </div>
  </div>
}

<!-- Delete Confirmation Modal -->
@if (itemToDelete(); as item) {
  <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 animate-pop-in">
    <div class="bg-white dark:bg-slate-800 rounded-lg shadow-2xl p-8 w-full max-w-md border border-slate-200 dark:border-slate-700 text-center">
      <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/50">
        <svg class="h-6 w-6 text-red-600 dark:text-red-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg>
      </div>
      <h2 class="text-2xl font-bold mt-4 text-slate-900 dark:text-white">{{ languageService.T('deleteConfirmationTitle') }}</h2>
      <p class="text-slate-500 dark:text-slate-400 mt-2">{{ languageService.T('deleteConfirmationMessage').replace('{itemType}', languageService.T('itemType_patient_appointment')).replace('{itemName}', getContactName(item.user_id) + ' @ ' + formatDateTime(item.appointment_date)) }}</p>
      <p class="text-sm text-red-500 dark:text-red-400 font-semibold mt-2">{{ languageService.T('deleteConfirmationWarning') }}</p>
      <div class="flex justify-center gap-4 mt-6">
        <button type="button" (click)="cancelDelete()" class="bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-700 text-slate-800 dark:text-white font-bold py-2 px-6 rounded-lg">{{ languageService.T('cancel') }}</button>
        <button type="button" (click)="confirmDelete()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">{{ languageService.T('confirmDeleteButton') }}</button>
      </div>
    </div>
  </div>
}
